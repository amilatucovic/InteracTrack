<!-- templates/agent_status.html -->
{% extends "base.html" %}

{% block title %}Status agenta - DDI Agent{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-robot"></i> Status DDI Agent-a</h2>
    <p class="text-muted">Detaljne informacije o stanju inteligentnog agenta</p>
    
    <!-- Loading indicator -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Učitavanje...</span>
        </div>
        <p class="mt-3">Učitavam podatke o agentu...</p>
    </div>
    
    <!-- Agent Status -->
    <div id="agentStatus" class="d-none">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Osnovne informacije</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Agent inicijaliziran:</strong> 
                            <span id="agentInitialized" class="badge bg-success">DA</span>
                        </p>
                        <p><strong>Pokrenut u pozadini:</strong> 
                            <span id="agentRunning" class="badge bg-secondary">NE</span>
                        </p>
                        <p><strong>Tip agenta:</strong> <span id="agentType">N/A</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Adaptivni prag:</strong> <span id="adaptiveThreshold">N/A</span></p>
                        <p><strong>Baza podataka:</strong> <span id="databasePath" class="text-truncate d-inline-block" style="max-width: 300px;"></span></p>
                        <p><strong>CSV dostupan:</strong> <span id="csvAvailable" class="badge bg-success">DA</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tick History -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> Historija tick-ova</h5>
            </div>
            <div class="card-body">
                <p><strong>Ukupno tick-ova:</strong> <span id="totalTicks">0</span></p>
                <p><strong>Nedavno pokrenuto:</strong> <span id="recentTicks">0</span></p>
                
                <div id="historyContainer" class="mt-3">
                    <!-- History will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Agent Actions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> Upravljanje agentom</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <form id="tickForm" action="/api/agent/tick" method="POST">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="bi bi-play-circle"></i> Pokreni tick
                            </button>
                            <small class="text-muted">Izvrši jedan ciklus (Sense→Think→Act→Learn)</small>
                        </form>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <form id="startForm" action="/api/agent/start" method="POST">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-play-fill"></i> Pokreni u pozadini
                            </button>
                            <small class="text-muted">Pokreni automatsko izvršavanje svakih 5s</small>
                        </form>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <form id="stopForm" action="/api/agent/stop" method="POST">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-stop-fill"></i> Zaustavi agenta
                            </button>
                            <small class="text-muted">Zaustavi pozadinsko izvršavanje</small>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load agent status
    loadAgentStatus();
    
    // Handle form submissions
    setupFormHandlers();
});

function loadAgentStatus() {
    fetch('/api/agent/status')
        .then(response => response.json())
        .then(data => {
            // Hide loading, show content
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('agentStatus').classList.remove('d-none');
            
            // Update basic info
            updateAgentInfo(data.agent);
            updateHistoryInfo(data.history);
            
            // Update history table
            renderHistory(data.history);
        })
        .catch(error => {
            console.error('Error loading agent status:', error);
            document.getElementById('loading').innerHTML = `
                <div class="alert alert-danger">
                    <h5>❌ Greška pri učitavanju</h5>
                    <p>${error.message}</p>
                    <button onclick="location.reload()" class="btn btn-sm btn-outline-danger">
                        Pokušaj ponovo
                    </button>
                </div>
            `;
        });
}

function updateAgentInfo(agent) {
    document.getElementById('agentInitialized').textContent = agent.initialized ? 'DA' : 'NE';
    document.getElementById('agentInitialized').className = `badge bg-${agent.initialized ? 'success' : 'danger'}`;
    
    document.getElementById('agentRunning').textContent = agent.running_in_background ? 'DA' : 'NE';
    document.getElementById('agentRunning').className = `badge bg-${agent.running_in_background ? 'success' : 'secondary'}`;
    
    document.getElementById('agentType').textContent = agent.type || 'N/A';
    document.getElementById('adaptiveThreshold').textContent = agent.adaptive_threshold !== null ? 
        agent.adaptive_threshold.toFixed(2) : 'N/A';
    document.getElementById('databasePath').textContent = agent.database || 'N/A';
    document.getElementById('csvAvailable').textContent = agent.csv_available ? 'DA' : 'NE';
    document.getElementById('csvAvailable').className = `badge bg-${agent.csv_available ? 'success' : 'danger'}`;
}

function updateHistoryInfo(history) {
    document.getElementById('totalTicks').textContent = history.total_ticks || 0;
    document.getElementById('recentTicks').textContent = history.recent_ticks || 0;
}

function renderHistory(history) {
    const container = document.getElementById('historyContainer');
    
    if (!history.last_actions || history.last_actions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                <p class="text-muted mt-2">Nema historije tick-ova</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Pacijent</th>
                        <th>Akcija</th>
                        <th>Vrijeme</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    history.last_actions.forEach(action => {
        html += `
            <tr>
                <td>${action.patient_id || 'N/A'}</td>
                <td>
                    <span class="badge bg-${getActionBadgeColor(action.action)}">
                        ${action.action || 'N/A'}
                    </span>
                </td>
                <td>${action.timestamp || 'N/A'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function getActionBadgeColor(action) {
    if (!action) return 'secondary';
    
    switch(action.toUpperCase()) {
        case 'WARN':
        case 'ESCALATE':
            return 'danger';
        case 'INFORM':
            return 'success';
        default:
            return 'secondary';
    }
}

function setupFormHandlers() {
    // Handle tick form
    document.getElementById('tickForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showAlert('success', 'Tick izvršen!', data.message || 'Agent je obradio terapiju.');
                setTimeout(() => loadAgentStatus(), 1000);
            })
            .catch(error => {
                showAlert('danger', 'Greška!', error.message);
            });
    });
    
    // Handle start form
    document.getElementById('startForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showAlert('success', 'Agent pokrenut!', data.message || 'Agent radi u pozadini.');
                setTimeout(() => loadAgentStatus(), 1500);
            })
            .catch(error => {
                showAlert('danger', 'Greška!', error.message);
            });
    });
    
    // Handle stop form
    document.getElementById('stopForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showAlert('info', 'Agent se zaustavlja...', data.message || 'Agent se zaustavlja.');
                setTimeout(() => loadAgentStatus(), 1500);
            })
            .catch(error => {
                showAlert('danger', 'Greška!', error.message);
            });
    });
}

function showAlert(type, title, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the container
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}